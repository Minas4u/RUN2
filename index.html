<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helios Marathon Plan & Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f4; /* stone-100 */
            color: #292524; /* stone-800 */
        }
        .main-container {
            background-color: #ffffff; /* white */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* shadow-2xl */
        }
        .nav-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-weight: 500;
        }
        .nav-button.active {
            background-color: #0284c7; /* sky-600 */
            color: white;
        }
        .nav-button:not(.active):hover {
            background-color: #e0f2fe; /* sky-100 */
            color: #0369a1; /* sky-700 */
        }
        .phase-button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #0ea5e9; /* sky-500 */
            color: #0369a1; /* sky-700 */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            font-weight: 500;
        }
        .phase-button.active {
            background-color: #0ea5e9; /* sky-500 */
            color: white;
        }
        .phase-button:not(.active):hover {
            background-color: #e0f2fe; /* sky-100 */
        }
        .week-button {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #9ca3af; /* gray-400 */
            color: #374151; /* gray-700 */
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            font-weight: 500;
            text-align: center;
        }
        .week-button.active {
            background-color: #0d9488; /* teal-600 */
            color: white;
            border-color: #0d9488; /* teal-600 */
        }
        .week-button:not(.active):hover {
            background-color: #f0fdfa; /* teal-50 */
            border-color: #14b8a6; /* teal-500 */
        }
        .content-card {
            background-color: #fafaf9; /* stone-50 */
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e7e5e4; /* stone-200 */
        }
        .content-card h3 {
            color: #0d9488; /* teal-600 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px; /* Increased max-width for better readability on wider screens */
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .data-table {
            width: 100%;
            margin-top: 0.5rem;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        .data-table th, .data-table td {
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            text-align: left;
        }
        .data-table th {
            font-weight: 600;
            background-color: #f3f4f6; /* gray-100 */
        }
        input[type="text"]:focus, input[type="number"]:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #0ea5e9; /* sky-500 */
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3); /* sky-500 with opacity */
        }
        .header-logo-container {
            display: inline-block;
            padding: 0.75rem;
            background-color: #0284c7; /* sky-600 */
            border-radius: 0.5rem;
        }
        .header-logo {
            max-height: 50px;
            display: block;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* slate-500 */
        }
    </style>
</head>
<body class="min-h-screen p-4 py-8">
    <div class="main-container w-full max-w-5xl mx-auto p-6 sm:p-8">
        <header class="mb-6 sm:mb-8 text-center">
            <div class="header-logo-container">
                <img src="https://iliosports.com/wp-content/uploads/2021/03/logo-13.png"
                     alt="Helios Running Team Logo"
                     class="header-logo"
                     onerror="this.parentElement.innerHTML='<h1 class=\'text-2xl sm:text-3xl font-bold text-white\'>Helios Running</h1>'">
            </div>
            <h1 class="text-2xl sm:text-3xl font-bold text-stone-800 mt-4">Marathon Plan & Training Tools</h1>
            <p class="text-stone-600">Your interactive guide to a sub-2:35 marathon and pace utilities.</p>
        </header>

        <nav class="mb-8 flex flex-wrap justify-center gap-2 sm:gap-4 border-b border-stone-300 pb-4">
            <button id="nav-overview" class="nav-button active">Plan Overview</button>
            <button id="nav-plan" class="nav-button">Training Plan</button>
            <button id="nav-utils" class="nav-button">Pace Utilities</button>
        </nav>

        <main id="app-content">
            </main>
    </div>

<script>
// Global variable to store the fetched and processed marathon plan data
let loadedMarathonPlan = null;
// Google Apps Script URL
const GSHEET_URL = "https://script.google.com/macros/s/AKfycbwTkewzr3kGXk8nZ2Z8LELS-8L-40qWptcb6-lIP8uIT-s_ZxMESGEJ_7HsaLJDTGV_/exec";

const appContent = document.getElementById('app-content');
let mileageChartInstance = null;

/**
 * Fetches data from the Google Sheet and processes it into the required format.
 */
async function fetchAndProcessMarathonData() {
    appContent.innerHTML = '<p class="text-center text-stone-600 p-8">Loading training plan data from Google Sheet...</p>';
    try {
        const response = await fetch(GSHEET_URL);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}. Ensure the Apps Script is deployed correctly and allows anonymous access if needed.`);
        }
        const rawData = await response.json();

        // Initialize the structure for the processed plan
        loadedMarathonPlan = {
            philosophy: { title: "Training Philosophy", content: [] },
            paceGuide: { title: "Pace Guide", paces: [] },
            generalNotes: { title: "Important Notes", notes: [] },
            phases: []
        };

        // --- Process PlanInfo Tab ---
        // Assumes PlanInfo sheet has columns: Section, Title (optional, can be on first row of section), Item
        const planInfoData = rawData.PlanInfo || [];
        
        const philosophyItems = planInfoData.filter(i => i.Section === 'philosophy');
        if (philosophyItems.length > 0) {
            loadedMarathonPlan.philosophy.title = philosophyItems[0].Title || "Training Philosophy";
            loadedMarathonPlan.philosophy.content = philosophyItems.map(i => i.Item).filter(Boolean);
        }

        const paceGuideItems = planInfoData.filter(i => i.Section === 'paceGuide');
        if (paceGuideItems.length > 0) {
            loadedMarathonPlan.paceGuide.title = paceGuideItems[0].Title || "Pace Guide (Approximate)";
            loadedMarathonPlan.paceGuide.paces = paceGuideItems.map(i => i.Item).filter(Boolean);
        }

        const generalNotesItems = planInfoData.filter(i => i.Section === 'generalNotes');
        if (generalNotesItems.length > 0) {
            loadedMarathonPlan.generalNotes.title = generalNotesItems[0].Title || "Important Notes Before You Start";
            loadedMarathonPlan.generalNotes.notes = generalNotesItems.map(i => i.Item).filter(Boolean);
        }
        
        // --- Process Phases, WeeklySchedule, and DailyWorkouts Tabs ---
        const phasesData = rawData.Phases || [];
        const weeklyScheduleData = rawData.WeeklySchedule || [];
        const dailyWorkoutsData = rawData.DailyWorkouts || [];

        phasesData.forEach(phaseRow => {
            // Assumes phaseRow has: PhaseID (unique), Name, Duration, Goal, MileageRange
            const phase = {
                id: phaseRow.PhaseID, 
                name: phaseRow.Name,
                duration: phaseRow.Duration,
                goal: phaseRow.Goal,
                mileageRange: phaseRow.MileageRange,
                weeks: []
            };

            // Filter weeks for this phase using PhaseID
            const phaseWeeks = weeklyScheduleData.filter(weekRow => weekRow.PhaseID === phase.id);
            phaseWeeks.forEach(weekRow => {
                // Assumes weekRow has: WeekID (unique), PhaseID, WeekNum, TotalKm, Notes
                const week = {
                    id: weekRow.WeekID, 
                    weekNum: weekRow.WeekNum,
                    totalKm: weekRow.TotalKm, // Can be string like "~60-70km" or number
                    notes: weekRow.Notes,
                    days: []
                };

                // Filter daily workouts for this week using WeekID
                // Assumes dailyWorkouts are sorted or DayName implies order (e.g. Mon, Tue)
                const weekDays = dailyWorkoutsData.filter(dayRow => dayRow.WeekID === week.id);
                weekDays.forEach(dayRow => {
                    // Assumes dayRow has: WeekID, DayName, Description
                    week.days.push(`${dayRow.DayName || 'Day'}: ${dayRow.Description || 'No description'}`);
                });
                phase.weeks.push(week);
            });
            loadedMarathonPlan.phases.push(phase);
        });
        
        // Initial render after data is loaded
        renderOverview(); 

    } catch (error) {
        console.error("Failed to load or process marathon data from Google Sheet:", error);
        appContent.innerHTML = `<div class="content-card bg-red-100 border-red-300 text-red-700 p-4 rounded-lg">
                                    <h3 class="font-semibold text-lg">Error Loading Training Plan</h3>
                                    <p>Could not fetch or process data from the Google Sheet.</p>
                                    <p class="text-sm mt-2"><strong>Details:</strong> ${error.message}</p>
                                    <p class="text-sm mt-1">Please ensure the Google Apps Script URL is correct, the script is deployed with appropriate permissions (e.g., accessible by "Anyone, even anonymous"), and the sheet names/column headers match the expected format.</p>
                                </div>`;
    }
}


function setActiveNav(activeId) {
    document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.id === activeId) {
            btn.classList.add('active');
        }
    });
}

function createHtmlList(items) {
    if (!items || items.length === 0) return '<p class="text-stone-500 italic">No information available.</p>';
    return `<ul class="list-disc list-inside space-y-1 text-stone-700">${items.map(item => `<li>${item}</li>`).join('')}</ul>`;
}

function renderOverview() {
    if (!loadedMarathonPlan) {
        appContent.innerHTML = '<p class="text-center text-stone-600 p-8">Plan data is not loaded yet.</p>';
        return;
    }
    setActiveNav('nav-overview');
    appContent.innerHTML = `
        <section id="overview-content" class="space-y-6">
            <div class="content-card">
                <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-3">${loadedMarathonPlan.philosophy.title}</h2>
                ${createHtmlList(loadedMarathonPlan.philosophy.content)}
            </div>

            <div class="content-card">
                <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-3">Overall Mileage Progression</h2>
                <div class="chart-container bg-white p-2 rounded-md shadow">
                    <canvas id="mileageChart"></canvas>
                </div>
                <p class="text-xs text-stone-500 mt-2 text-center">Hover over points to see weekly mileage. Note: Some initial entries might be partial weeks.</p>
            </div>

            <div class="content-card">
                <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-3">${loadedMarathonPlan.paceGuide.title}</h2>
                ${createHtmlList(loadedMarathonPlan.paceGuide.paces)}
            </div>

            <div class="content-card">
                <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-3">${loadedMarathonPlan.generalNotes.title}</h2>
                ${createHtmlList(loadedMarathonPlan.generalNotes.notes)}
            </div>
        </section>
    `;
    renderMileageChart();
}

function renderMileageChart() {
    const chartCanvas = document.getElementById('mileageChart');
    if (!chartCanvas || !loadedMarathonPlan || !loadedMarathonPlan.phases) return;

    const labels = [];
    const dataPoints = [];
    
    loadedMarathonPlan.phases.forEach(phase => {
        phase.weeks.forEach(week => {
            labels.push(`W${week.weekNum}`); // Assumes weekNum is like "1", "2", "June 1-2"
            let kmValue = 0;
            if (typeof week.totalKm === 'string') {
                const rangeMatch = week.totalKm.match(/~(\d+)\s*-\s*(\d+)/); // e.g., ~60-65 or ~60 - 65
                const singleMatchWithTilde = week.totalKm.match(/~(\d+)/);    // e.g., ~60
                const plainNumberMatch = week.totalKm.match(/^(\d+)$/);      // e.g., 60
                const firstNumberMatch = week.totalKm.match(/\d+/); // Fallback: first number found

                if (rangeMatch) {
                    kmValue = parseInt(rangeMatch[1], 10); // Use the lower end of the range
                } else if (singleMatchWithTilde) {
                    kmValue = parseInt(singleMatchWithTilde[1], 10);
                } else if (plainNumberMatch) {
                    kmValue = parseInt(plainNumberMatch[1], 10);
                } else if (firstNumberMatch) {
                    kmValue = parseInt(firstNumberMatch[0], 10);
                }
            } else if (typeof week.totalKm === 'number') {
                kmValue = week.totalKm; 
            }
            dataPoints.push(kmValue);
        });
    });

    if (mileageChartInstance) {
        mileageChartInstance.destroy();
    }

    mileageChartInstance = new Chart(chartCanvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Planned Weekly Kilometers',
                data: dataPoints,
                borderColor: '#0d9488', // teal-600
                backgroundColor: 'rgba(13, 148, 136, 0.1)', // teal-600 with alpha
                tension: 0.1,
                fill: true,
                pointBackgroundColor: '#0d9488', // teal-600
                pointBorderColor: '#fff',
                pointHoverRadius: 7,
                pointHoverBackgroundColor: '#0d9488' // teal-600
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Kilometers (km)', font: { weight: '500' } }
                },
                x: {
                    title: { display: true, text: 'Training Week', font: { weight: '500' } },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 20, 
                        callback: function(value, index, values) {
                            const label = this.getLabelForValue(value);
                            // Basic label wrapping, can be improved
                            if (label.length > 10 && label.includes(" ")) { 
                                return label.split(" "); // Chart.js can handle array of strings for multi-line labels
                            }
                            if (label.length > 16) { 
                                return label.substring(0,15) + '...';
                            }
                            return label;
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    enabled: true,
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleFont: { weight: 'bold' },
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} km`;
                        }
                    }
                },
                legend: {
                    labels: { font: { weight: '500' } }
                }
            }
        }
    });
}

function renderTrainingPlan() {
    if (!loadedMarathonPlan) {
        appContent.innerHTML = '<p class="text-center text-stone-600 p-8">Plan data is not loaded yet.</p>';
        return;
    }
    setActiveNav('nav-plan');
    const phaseButtonsHtml = loadedMarathonPlan.phases.map((phase, index) =>
        `<button class="phase-button" data-phase-index="${index}">${phase.name}</button>`
    ).join('');

    appContent.innerHTML = `
        <section id="training-plan-content" class="space-y-6">
            <div>
                <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-4">Select Training Phase:</h2>
                <div id="phase-navigation" class="flex flex-wrap gap-2 mb-6">
                    ${phaseButtonsHtml}
                </div>
                <div id="phase-details" class="space-y-4">
                    <p class="text-stone-600 italic">Select a phase to see its details and weekly breakdown.</p>
                </div>
            </div>
            <div id="week-details-container" class="mt-6">
                </div>
        </section>
    `;

    document.querySelectorAll('#phase-navigation .phase-button').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll('#phase-navigation .phase-button').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            const phaseIndex = parseInt(e.target.dataset.phaseIndex);
            renderPhaseDetails(phaseIndex);
        });
    });
     // Automatically select and render the first phase if available
    if (loadedMarathonPlan.phases.length > 0) {
        const firstPhaseButton = document.querySelector('#phase-navigation .phase-button');
        if (firstPhaseButton) {
            firstPhaseButton.click();
        }
    }
}

function renderPhaseDetails(phaseIndex) {
    if (!loadedMarathonPlan) return;
    const phase = loadedMarathonPlan.phases[phaseIndex];
    if (!phase) {
        document.getElementById('phase-details').innerHTML = '<p class="text-red-500">Selected phase not found.</p>';
        return;
    }
    const phaseDetailsDiv = document.getElementById('phase-details');
    document.getElementById('week-details-container').innerHTML = ''; // Clear previous week details

    const weekButtonsHtml = phase.weeks.map((week, index) =>
        `<button class="week-button" data-phase-index="${phaseIndex}" data-week-index="${index}">Week ${week.weekNum}</button>`
    ).join('');

    phaseDetailsDiv.innerHTML = `
        <div class="content-card">
            <h3 class="text-lg sm:text-xl font-semibold mb-2">${phase.name} (${phase.duration || 'N/A'})</h3>
            <p class="text-sm text-stone-600 mb-1"><strong>Goal:</strong> ${phase.goal || 'N/A'}</p>
            <p class="text-sm text-stone-600 mb-3"><strong>Mileage:</strong> ${phase.mileageRange || 'N/A'}</p>
            <h4 class="text-md font-medium text-stone-700 mb-2">Select a Week:</h4>
            <div id="week-navigation-${phaseIndex}" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2">
                ${weekButtonsHtml.length > 0 ? weekButtonsHtml : '<p class="col-span-full text-stone-500 italic">No weeks defined for this phase.</p>'}
            </div>
        </div>
    `;

    document.querySelectorAll(`#week-navigation-${phaseIndex} .week-button`).forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll(`#week-navigation-${phaseIndex} .week-button`).forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            const pIdx = parseInt(e.target.dataset.phaseIndex);
            const wIdx = parseInt(e.target.dataset.weekIndex);
            renderWeekDetails(pIdx, wIdx);
        });
    });
     // Automatically select and render the first week if available
    if (phase.weeks.length > 0) {
        const firstWeekButton = document.querySelector(`#week-navigation-${phaseIndex} .week-button`);
        if (firstWeekButton) {
            firstWeekButton.click();
        }
    } else {
         document.getElementById('week-details-container').innerHTML = ''; // Clear if no weeks
    }
}

function renderWeekDetails(phaseIndex, weekIndex) {
    if (!loadedMarathonPlan) return;
    const week = loadedMarathonPlan.phases[phaseIndex]?.weeks[weekIndex];
    if (!week) {
         document.getElementById('week-details-container').innerHTML = '<p class="text-red-500 content-card mt-4">Selected week not found.</p>';
        return;
    }
    const weekDetailsContainer = document.getElementById('week-details-container');

    const dailyScheduleHtml = week.days.map(day => {
        // Handles cases where day might not have ':' correctly
        const parts = day.split(':');
        const dayTitle = parts[0] ? `<strong class="text-teal-700">${parts[0].trim()}:</strong>` : '';
        const dayDesc = parts.slice(1).join(':').trim();
        return `<li class="py-1">${dayTitle} ${dayDesc}</li>`;
    }).join('');

    weekDetailsContainer.innerHTML = `
        <div class="content-card mt-4">
            <h4 class="text-lg font-semibold text-sky-700 mb-2">Schedule for Week ${week.weekNum}</h4>
            <p class="text-sm text-stone-600 mb-1"><strong>Total Mileage:</strong> ${week.totalKm || 'N/A'}</p>
            <ul class="list-none space-y-1 text-sm text-stone-700 mb-2">
                ${week.days.length > 0 ? dailyScheduleHtml : '<li class="text-stone-500 italic">No daily schedule defined for this week.</li>'}
            </ul>
            ${week.notes ? `<p class="text-sm text-stone-600 italic mt-2"><strong>Notes:</strong> ${week.notes}</p>` : ''}
        </div>
    `;
}

function renderPaceUtilities() {
    setActiveNav('nav-utils');
    appContent.innerHTML = `
        <section id="pace-utils-content" class="space-y-6">
            <div class="content-card">
                <h2 class="text-xl sm:text-2xl font-semibold text-sky-700 mb-4">Training Zone & Repeats Pace Calculator</h2>
                <div class="mb-6">
                    <label for="lt2speed" class="block text-sm font-medium text-stone-700 mb-1">Enter LT2 Speed (pace per km):</label>
                    <input type="text" id="lt2speed" name="lt2speed" placeholder="e.g., 4:30"
                           class="mt-1 block w-full px-4 py-3 border border-stone-300 rounded-lg shadow-sm sm:text-sm transition duration-150 ease-in-out">
                    <div id="error-message-calc" class="text-red-500 text-sm mt-2 h-5"></div>
                </div>

                <button onclick="calculatePacesFromUtil()"
                        class="w-full bg-sky-600 hover:bg-sky-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition duration-150 ease-in-out transform hover:scale-105">
                    Calculate Zones & Repeats Paces
                </button>

                <div class="mt-8 md:flex md:space-x-6">
                    <div id="zones-section-util" class="flex-1">
                        <h3 class="text-lg font-semibold text-stone-700 mb-2 border-b border-stone-300 pb-2">Training Zones:</h3>
                        <div id="zones-content-util">
                            <p class="text-stone-500 italic text-sm">Enter your LT2 speed and click calculate.</p>
                        </div>
                    </div>

                    <div id="repeats-section-util" class="flex-1 mt-8 md:mt-0">
                        <h3 class="text-lg font-semibold text-stone-700 mb-2 border-b border-stone-300 pb-2">Repeats Paces:</h3>
                        <div id="repeats-content-util">
                            <p class="text-stone-500 italic text-sm">Calculated based on your LT2 speed.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    `;
    document.getElementById('lt2speed').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            calculatePacesFromUtil();
        }
    });
}

function parsePaceToSeconds(paceString) {
    if (!paceString || typeof paceString !== 'string') return NaN;
    const parts = paceString.trim().split(':');
    if (parts.length !== 2) return NaN;
    const minutes = parseInt(parts[0], 10);
    const seconds = parseInt(parts[1], 10);
    if (isNaN(minutes) || isNaN(seconds) || minutes < 0 || seconds < 0 || seconds >= 60) return NaN;
    return (minutes * 60) + seconds;
}

function formatSecondsToPace(totalSeconds) {
    if (isNaN(totalSeconds) || totalSeconds < 0) return "N/A";
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = Math.round(totalSeconds % 60); // Round seconds for display
    return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
}

function calculatePacesFromUtil() {
    const lt2SpeedInput = document.getElementById('lt2speed').value;
    const zonesContentDiv = document.getElementById('zones-content-util');
    const repeatsContentDiv = document.getElementById('repeats-content-util');
    const errorMessageDiv = document.getElementById('error-message-calc');

    zonesContentDiv.innerHTML = '<p class="text-stone-500 italic text-sm">Calculating...</p>';
    repeatsContentDiv.innerHTML = '<p class="text-stone-500 italic text-sm">Calculating...</p>';
    errorMessageDiv.textContent = '';

    const lt2SpeedInSeconds = parsePaceToSeconds(lt2SpeedInput);

    if (isNaN(lt2SpeedInSeconds) || lt2SpeedInSeconds <= 0) {
        errorMessageDiv.textContent = 'Invalid LT2 speed. Use mm:ss format (e.g., 4:30). Pace must be positive.';
        zonesContentDiv.innerHTML = '<p class="text-red-500 italic text-sm">Could not calculate zones due to invalid input.</p>';
        repeatsContentDiv.innerHTML = '<p class="text-red-500 italic text-sm">Could not calculate repeats paces due to invalid LT2 input.</p>';
        return;
    }

    // These percentages are examples and can be adjusted based on specific training methodologies
    const zonesData = [
        { name: "Zone 1", descriptor: "Easy/Recovery", lowPercent: 60, highPercent: 75, colorClass: "text-green-600" }, // Slower than LT2
        { name: "Zone 2", descriptor: "Aerobic/Base", lowPercent: 76, highPercent: 86, colorClass: "text-sky-600" },      // Slower than LT2
        { name: "Zone 3", descriptor: "Tempo/Aerobic+", lowPercent: 87, highPercent: 99, colorClass: "text-lime-600" },  // Around LT2
        { name: "Zone 4", descriptor: "Threshold", lowPercent: 100, highPercent: 105, colorClass: "text-amber-500" }, // Slightly faster than LT2
        { name: "Zone 5", descriptor: "VO2 Max", lowPercent: 106, highPercent: 115, colorClass: "text-orange-500" }, // Faster than LT2
        { name: "Zone 6", descriptor: "Anaerobic", lowPercent: 116, highPercent: 145, colorClass: "text-red-600" }    // Much faster than LT2
    ];
    // Race Pace is often a specific target, this is an example
    const racePaceInfo = { name: "Target Marathon Pace", descriptor: "(Example)", lowPercent: 90, highPercent: 92, colorClass: "text-purple-600" };


    zonesContentDiv.innerHTML = '';
    const zonesTable = document.createElement('table');
    zonesTable.classList.add('data-table', 'text-sm');
    zonesTable.innerHTML = `<thead><tr><th class="bg-stone-100">Zone</th><th class="bg-stone-100">Pace Range (/km)</th></tr></thead><tbody></tbody>`;
    const zonesTbody = zonesTable.querySelector('tbody');

    // Note: For pace, higher percentage of LT2 *speed* means a *faster* pace (lower mm:ss).
    // So, LT2 pace / (percentage/100) gives the target pace.
    // Slower end of zone = LT2_pace / (lowPercent/100)
    // Faster end of zone = LT2_pace / (highPercent/100)
    [...zonesData, racePaceInfo].forEach(zone => {
        const slowerPaceSeconds = lt2SpeedInSeconds / (zone.lowPercent / 100); // This gives a slower time (higher mm:ss)
        const fasterPaceSeconds = lt2SpeedInSeconds / (zone.highPercent / 100); // This gives a faster time (lower mm:ss)
        
        const row = zonesTbody.insertRow();
        row.insertCell().innerHTML = `<strong class="${zone.colorClass}">${zone.name} ${zone.descriptor ? '['+zone.descriptor+']' : ''}</strong>`;
        // Display faster pace first as it's the "lower bound" in mm:ss
        row.insertCell().textContent = `${formatSecondsToPace(fasterPaceSeconds)} - ${formatSecondsToPace(slowerPaceSeconds)}`;
    });
    zonesContentDiv.appendChild(zonesTable);

    // Repeats paces are typically faster than LT2
    const repeatDistances = [
        // Percentages are of LT2 pace. e.g. 100m at 105% of LT2 pace means 1/ (105/100) * LT2_pace_seconds
        { distance: "1000m", lowPercent: 100, highPercent: 102, note: "Near 10k pace" }, // e.g., 100-102% of LT2 pace
        { distance: "800m",  lowPercent: 101, highPercent: 104, note: "Faster than 10k pace" },
        { distance: "400m",  lowPercent: 104, highPercent: 108, note: "Near 5k pace or faster" },
        { distance: "200m",  lowPercent: 106, highPercent: 112, note: "Mile pace or faster" }
    ];

    repeatsContentDiv.innerHTML = '';
    const repeatsTable = document.createElement('table');
    repeatsTable.classList.add('data-table', 'text-sm');
    repeatsTable.innerHTML = `<thead><tr><th class="bg-stone-100">Distance</th><th class="bg-stone-100">Target Time Range</th><th class="bg-stone-100">Pace Range (/km)</th></tr></thead><tbody></tbody>`;
    const repeatsTbody = repeatsTable.querySelector('tbody');

    repeatDistances.forEach(item => {
        const fasterPacePerKmSeconds = lt2SpeedInSeconds / (item.highPercent / 100);
        const slowerPacePerKmSeconds = lt2SpeedInSeconds / (item.lowPercent / 100);

        let distanceMultiplier = 1; 
        if (item.distance === "800m") distanceMultiplier = 0.8;
        else if (item.distance === "400m") distanceMultiplier = 0.4;
        else if (item.distance === "200m") distanceMultiplier = 0.2;
        // else if (item.distance === "300m") distanceMultiplier = 0.3; // Example if you add 300m

        const fasterTimeForDistance = fasterPacePerKmSeconds * distanceMultiplier;
        const slowerTimeForDistance = slowerPacePerKmSeconds * distanceMultiplier;

        const row = repeatsTbody.insertRow();
        row.insertCell().innerHTML = `<strong class="text-teal-700">${item.distance}</strong> <em class="text-xs text-stone-500">(${item.note || ''})</em>`;
        row.insertCell().textContent = `${formatSecondsToPace(fasterTimeForDistance)} - ${formatSecondsToPace(slowerTimeForDistance)}`;
        row.insertCell().textContent = `${formatSecondsToPace(fasterPacePerKmSeconds)} - ${formatSecondsToPace(slowerPacePerKmSeconds)}`;
    });
    repeatsContentDiv.appendChild(repeatsTable);
    repeatsContentDiv.innerHTML += `<p class="text-xs text-stone-500 mt-2">Note: Target times are for the specified repeat distance. Pace range is the equivalent per/km pace for that effort.</p>`;
}


// Navigation event listeners
document.getElementById('nav-overview').addEventListener('click', renderOverview);
document.getElementById('nav-plan').addEventListener('click', renderTrainingPlan);
document.getElementById('nav-utils').addEventListener('click', renderPaceUtilities);

// Initial load: Fetch data and then render the default view
fetchAndProcessMarathonData();

</script>
</body>
</html>
